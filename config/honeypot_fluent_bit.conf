# ─────────────────────────────────────────────────────────────
#  NeoVigil Honeypot Sidecar — Fluent Bit Configuration
# ─────────────────────────────────────────────────────────────
#  This sidecar runs DUAL-HOMED:
#    1. honeypot-net-{id}  →  reads container logs via Forward input
#    2. opensearch-net     →  writes to SOC relay endpoint via HTTP
#
#  The honeypot container itself has NO production network access.
#  This config is the ONE-WAY telemetry bridge.
# ─────────────────────────────────────────────────────────────

[SERVICE]
    Flush           2
    Daemon          Off
    Log_Level       info
    Parsers_File    parsers.conf

# ─── Input: Forward Protocol ────────────────────────────────
#  Honeypot containers can use the Fluent Forward protocol
#  to ship logs to the sidecar via the shared honeypot bridge.
[INPUT]
    Name            forward
    Listen          0.0.0.0
    Port            24224
    Tag             honeypot.*

# ─── Input: Tail the honeypot container stdout ──────────────
#  Fallback: if the honeypot image doesn't support Forward,
#  tail its stdout/stderr via the Docker log driver.
[INPUT]
    Name            tail
    Path            /var/log/containers/*.log
    Tag             honeypot.tail
    Read_from_Head  False
    Refresh_Interval 5

# ─── Filter: Enrich with decoy metadata ─────────────────────
#  Inject the DECOY_ID (passed via container env) into every
#  telemetry record so the Validation Engine can correlate.
[FILTER]
    Name            modify
    Match           honeypot.*
    Add             decoy_id ${DECOY_ID}
    Add             source_type honeypot_sidecar
    Add             pipeline    neovigil_deception

# ─── Output: HTTP → SOC SOAR Relay → RabbitMQ ───────────────
#  Sends telemetry to the soar-server /honeypot_event endpoint,
#  which relays it to the 'honeypot_events' RabbitMQ queue.
#
#  This path is: sidecar → opensearch-net → soar-server:5000
#  The soar-server publishes to RabbitMQ → validation engine.
[OUTPUT]
    Name            http
    Match           honeypot.*
    Host            soar-server
    Port            5000
    URI             /honeypot_event
    Format          json
    json_date_key   timestamp
    json_date_format iso8601
    Retry_Limit     3
    tls             Off
